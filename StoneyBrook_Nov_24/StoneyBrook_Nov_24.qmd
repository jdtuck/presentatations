---
title: Functional Data Analysis
subtitle:  with Applications to Changepoint Problems
format: clean-revealjs
revealjs-plugins:
  - pointer
author:
  - name: J. Derek Tucker
    orcid: 0000-0001-8844-2169
    email: jdtuck@sandia.gov
    affiliations: Sandia National Laboratories
date: November 19, 2024
fig-cap-location: top
css: styles.css

---

## {visibility="hidden"}
::: {.hidden}
$$
\def\x{{\mathbf x}}
\def\y{{\mathbf y}}
\def\f{{\mathbf f}}
\def\a{{\mathbf a}}
\def\b{{\mathbf b}}
\def\F{{\mathcal F}}
\def\S{{\mathcal S}}
\def\R{{\mathcal R}}
\def\u{{\mathbf u}}
\def\bfv{{\mathbf v}}
\def\w{{\mathbf w}}
\def\z{{\mathbf z}}
\def\1{{\mathbf 1}}
\def\bnu{\boldsymbol{\nu}}
\def\Span{{\textnormal Span}}
\def\diag{\textnormal{diag}}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\arginf}{arg\,inf}
\DeclareMathOperator*{\argsup}{arg\,sup}
\DeclareMathOperator{\cov}{cov}
\DeclareMathOperator{\Kern}{Kern}
\DeclareMathOperator{\pen}{pen}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\corr}{corr}
\DeclareMathOperator{\var}{var}
\DeclareMathOperator{\ccorsq}{ccorsq}
\newcommand{\diff}{{\mathscr{D}}}
\newcommand{\sone}{{\mathbb{S}^1}}
\newcommand{\s}{{\mathbb{S}}}
\newcommand{\real}{\mathbb{R}}
\newcommand{\fspace}{{\mathcal{F}}}
\newcommand{\T}{{\mathsf{T}}}
\newcommand{\sphere}{{\mathbb{S}^2}}
\newcommand{\ltwo}{{\mathbb{L}^2}}
\newcommand{\ltwoRn}{{\mathbb{L}^2(I,\real^n)}}
\newcommand{\inner}[2]{\left\langle #1,#2 \right\rangle}
\newcommand{\innerd}[2]{\left\langle \left\langle#1,#2 \right\rangle \right\rangle}

$$
:::

## Outline
- Definition of Functional Data Analysis
    + Examples
- Mathematical Framework
    + FDA vs Multivariate Statistics
    + Summary Statistics
    + Data Representations
    + Smoothing Functional Data
- Alignment of Functional Data
    + Elastic Method
- Functional Changepoint Problem
    + Elastic Method
    + Results

## References
- "Functional Data Analysis", By James Ramsay, B. W. Silverman
- Standard Textbook covers basic methods with a basis-based approach

<center>![](figs/ramsay_book.png)</center>

## References
- "Functional and Shape Data Analysis"", By Anuj Srivastava, Eric P Klassen
- Recent book on advances using more theoretical foundations

<center>![](figs/anuj_book.png){width="30%"}</center>

## Introduction
- Problem of statistical analysis of function data (FDA) is important in a wide variety of applications
- Easily encounter a problem where the observations are real-valued functions on an interval, and the goal is to perform their statistical analysis
- By statistical analysis we mean to [compare, align, average, and model]{.alert} a collection of random observations

::: {layout-ncol=3}
![Canadian Weather](figs/CandianWeather.png){fig-align="center" width="95%"}

![Female Growth](figs/femalegrowth.png){fig-align="center" width="95%"}

![iPhone Bike](figs/iphone_bike.png){fig-align="center" width="95%"}
:::

## Introduction
- Questions then arise on how can we model the functions
    + [Can we use the functions to classify diseases?]{.alert}
    + [Can we use them as predictors in a regression model]{.alert}
    + It is the same goal (questions) of any area of statistical study
- One problem occurs when performing these type of analyses is that functional data can contain variability in time ($x$-direction) and amplitude ($y$-direction)
- How do we [account]{.alert} for and handle this variability in the models that are constructed from functional data

## Types of Functional Data
- [Real-valued functions, with interval domain:]{.alert}  $f:[a,b]\rightarrow\mathbb{R}$

<center>![](figs/Rexample.png)</center>

## Types of Functional Data
- [$\mathbb{R}^n$-valued functions with interval domain, Or Parameterized Curves:]{.alert}  $f:[a,b]\rightarrow\mathbb{R}^n$ $f:S^1\rightarrow\mathbb{R}^n$

<center>![](figs/curveexample.png)</center>

## Types of Functional Data
- [$\mathbb{R}^3$-R3-valued functions on a spherical domain, Or Parameterized Surfaces:]{.alert}  $f:S^2\rightarrow\mathbb{R}^3$

<center>![](figs/surfaceexample.png)</center>


## Types of Functional Data
- [$\mathbb{R}^n$-valued functions with square or cube domains, Or Images:]{.alert}  $f:[0,1]^2\rightarrow\mathbb{R}^n$


<center>
![](figs/imageexample1.png){width="65%"}
![](figs/imageexample2.png){width="65%"}

</center>

## FDA Versus Multivariate Statistics

<center>![](figs/fda1.png)</center>

- Not all observations will have the same time indices
- Even if they do, we want the ability to change time indices

## FDA Versus Multivariate Statistics

<center>![](figs/fda2.png)</center>

## FDA Versus Multivariate Statistics
<center>![](figs/fda3.png)</center>

## FDA Versus Multivariate Statistics
- In FDA, one develops the \alert{theory} on function spaces and not finite vectors, and discretizes the functions only at the final step – computer implementation.

<center>![](figs/ulf.png)</center>


- Ulf Grenander: “[Discretize as late as possible]{.alert}” (1924-2016)
- Even after discretization, we retain the ability to interpolate resample 
	as needed!

## Common Metric Structure for FDA
- Let $f$ be a real-valued function with the domain $[0,1]$, can be extended to any domain
    + Only functions that are absolutely continuous on $[0,1]$ will be considered
- The $\mathbb{L}^2$ inner-product:
$$\left\langle f_1,f_2 \right\rangle = \int_0^1 f_1(t)f_2(t)\,dt$$
- $\mathbb{L}^2$ distance between functions:
$$ ||f_1-f_2|| = \sqrt{\int_0^1 (f_1(t)-f_2(t))^2\,dt}$$
- From these we will build summary statistics, but how good are they?


## Summary Statistics
- Assume that we have a collection of functions, $f_i(t)$, $i=1,\dots,N$ and we wish to calculate statistics on this set
- \alert{Mean Function}
$$\bar{f}(t) = \frac{1}{N}\sum_{i=1}^N f_i(t)$$
- \alert{Variance Function}
$$\var(f(t)) = \frac{1}{N-1}\sum_{i=1}^N \left(f_i(t) - \bar{f}(t)\right)^2$$
- and the standard deviation function is the point-wise square root of the
variance function

## Summary Statistics
- The covariance function summarizes the dependence of functions across
different time values and is computed for all $t_1$ and $t_2$
$$\cov_f(t_1,t_2) = \frac{1}{N-1} \sum_{i=1}^N \left(f_i(t_1) - \bar{f}(t_1)\right)\left(f_i(t_2) - \bar{f}(t_2)\right)$$
- The correlation function is then computed using
$$\corr_f(t_1,t_2) = \frac{\cov_f(t_1,t_2)}{\sqrt{\var(f(t_1))\var(f(t_2))}}$$
- [Note:]{.alert} These all assume the functions are aligned in time, if not analysis will be affected
    + More on this later...

## Phase Amplitude Separation
- All of these methods assume the data has no phase-variability or is aligned
- How does this affect the analysis?
- Can we account for it?

<center>
![](figs/toy2_f.png){width="33%"}
![](figs/toy2_meanf0.png){width="33%"}
</center>

## Motivation

<center>
![](figs/alignment_example.png)
</center>

- If one performs fPCA on this data and imposes the standard independent normal models on fPCA coefficients, the resulting model will lack this unimodal structure
- A proper technique is to incorporate the phase and amplitude variability, into the model construction which in turn incorporates into the component analysis

## Functional Data Alignment
<center>
![](figs/alignment_diagram.png){width="65%"}
</center>

## Functional Data Alignment
- There are few different methods that have been proposed (Ramsay, Mueller, Srivastava)
- We will focus on Elastic Method of (Srivastava, Wu, Tucker, Kurtek) as it uses a proper metric
- Let elements of the group $\Gamma$ play the role of warping functions as the set of boundary-preserving diffeomorphisms, $\gamma: [0,1] \to [0,1]$
- For any $f$, the operation, $f\circ\gamma$ denotes the time warping of $f$ by $\gamma$

## Functional Data Alignment
- [Problem:]{.alert} Under the standard $\ltwo$ metric,
    + The action of $\Gamma$ does not act by isometries since $\| f_1\circ \gamma - f_2 \circ \gamma\|\neq\| f_1 - f_2 \|$
- [Solutions:]{.alert}
    + Use the *square-root slope function* or SRSF of $f$
$$ q(t) = \mbox{sign}(\dot{f}(t)) \sqrt{ |\dot{f}(t)|} $$
- where $\| q_1 - q_2 \| = \| (q_1, \gamma) - (q_2, \gamma) \|$ and $(q_1, \gamma) = (q_1 \circ \gamma)\sqrt{\dot{\gamma}}$
- Leads to a distance on $\F / \Gamma$: $d_a(f_1, f_2) = \inf_{\gamma \in \Gamma} \|q_1 - (q_2,\gamma)\|$

## Pinching Problem
- Why use the \alert{SRSF}?
    + The $\ltwo$ distance is a proper distance
    + The action of $\Gamma$ does act by isometries
    + Solves the pinching problem
    
<center>
![](figs/pinching.png){width="65%"}
</center>

## Elastic Function Alignment
- [Alignment:]{.alert}
    1. Alignment is performed by finding the empirical Karcher mean
    $$ \mu_q = \argmin_{q \in \ltwo} \sum_{i=1}^n \left( \inf_{\gamma_i \in \Gamma} \| q - (q_i, \gamma_i) \|^2 \right)$$
    2. [Note]{.alert} that if ${\mu}_q$ is a minimizer of the cost function, then so is $({\mu}_q ,\gamma)$ for any $\gamma \in \Gamma$ since the metric is invariant to random warpings
    3. To make the choice unique we choose the $\mu_q$ of the set $\{ (\mu_q,\gamma) | \gamma \in \Gamma\}$ such that the mean of $\{\gamma_i^*\}$ is identity
    
## Elastic Function Alignment
<center>
![](figs/align_toy.png){width="95%"}
</center>

## Why SRSF of $\gamma_i$
<center>
![](figs/spheremap.png){width="32%"}
</center>
- $\Gamma$ is a nonlinear manifold and it is infinite dimensional
- Represent an element $\gamma \in \Gamma$ by the square-root of its derivative $\psi = \sqrt{\dot{\gamma}}$
- Important advantage of this transformation is that set of all such $\psi$s is a Hilbert sphere $\s_{\infty}$

## Functional Changepoint Problem
-   Assume we have real-valued functions $f_1,\dots,f_n$ that are absolutely continuous on the interval $[0,1]$
-   The standard changepoint problem assumes the data is from the following model:
$$f_i = \mu + \delta \mathbb{1}(i > k^*) + \epsilon_i$$
- The point $k^*$ labels the time of the unknown mean change
- The changepoint detection problem then becomes a hypothesis testing problem of 
$$ H_0: \delta = 0~~\text{vs}~~H_A: \delta\neq 0 $$

## Functional Changepoint Problem
- Aue 2019 considers test statistic, $T_n = \max_{1 \leq  k \leq n} \lVert S_{n,k}\rVert^2$ where,
$$S_{n,k} = \frac{1}{\sqrt{n}} \left( k\mu_k -  k \mu_n\right)$$
- where $\mu_k = k^{-1} \sum_{i=1}^k f_i$
- Estimate of $k^*$
$$\hat{k}^*  =\arg\max_{1\leq k\leq n}\lVert S_{n,k}\rVert^2$$
- Does [not]{.alert} take into account both amplitude and phase variability

## Elastic Functional Changepoint
- We propose the model, based on the definition of $q$ and $\Gamma$
$$q_i = \left( (\mu_q + \delta_q \mathbb{1}(i > k^*) + \epsilon_i), \gamma_i^{-1}\right)$$
- Change point problem:
$$ H_0: \delta_q = 0~~\text{vs}~~H_A: \delta_q \neq 0 $$
- Test Statistic 
$$S_{n,k} = \frac{1}{\sqrt{n}}\left(k\mu_q^k-k\mu_q^n\right)$$
- where, $\mu_q^k = \arg\min_{q} \sum_{i=1}^k d_a(q,q_i)^2$

## Phase Changepoint Problem
- We consider a model for $\gamma_i$
$$ \gamma_i =\begin{cases}
\eta_i(\mu_{\gamma}) & \textrm{if } i \leq k^* \\
\eta_i(\nu_{\gamma}) & \textrm{if } i > k^*
\end{cases} $$
- where $\eta_i(\mu)$ denotes a random element of $\Gamma$ with mean $\mu \in \Gamma$
- Change Point Problem 
$$ H_0: \mu_{\gamma}= \nu_{\gamma}~~\text{vs}~~H_A: \mu_{\gamma}\neq \nu_{\gamma} $$
- Test Statistic using Hilbert Sphere representation
$$ S_{n,k} = \frac{1}{\sqrt{n}}\left(k\bar{v}^k - k \bar{v}^n\right) $$
- where $\bar{v}^k$ is the shooting vector of the Karcher mean of the warping functions 

## Simulation Amplitude Changepoint

::: {.column width="49.5%"}
![](figs/sim_amp_mean_compare.png)
:::

::: {.column width="49.5%"}
![](figs/sim_amp_data.png)
:::

- Mean Functions
$$ \begin{align*}
\mu(t) &= a_0\cos(2\pi t) + b_0\sin(2\pi t) + a_1\cos(4\pi t) + b_1\sin(4\pi t) \\
\delta(t) &= \Delta\cos(2\pi t) +  \Delta\sin(2\pi t) + \Delta\cos(4\pi t) + \Delta\sin(4\pi t)
\end{align*} $$
-  $a_i\sim U[0,1]$ and $b_i \sim U[0,1]$ and $\Delta=0.5$

## Simulation Phase Changepoint

::: {.column width="32%"}
<center>

![](figs/sim_phase_data.png)

</center>
:::

::: {.column width="32%"}
<center>

![](figs/sim_phase_est_means.png)

</center>
:::

::: {.column width="32%"}
<center>

![](figs/sim_phase_est_means_cs.png)

</center>
:::

- Same set up as before 
- We take $\delta(t)=0$, and the warping functions have mean $\gamma(t) = t$ before $k^*$
- After $k^*$, the mean of the warping functions is a randomly-generated warping function with variance $.15$

## MERRA-2 stratospheric temperature

::: {.column width="49.5%"}
![](figs/era5_f.png)
:::

::: {.column width="49.5%"}
- Stratospheric temperature of the climate reanalysis data MERRA-2
- Using data from the years 1984-1998, we aim to evaluate changes related to the eruption of Mt.\ Pinatubo in June 1991
- We focus on daily stratospheric temperature near the 50 millibar pressure surface
:::

## Changepoint Results at One Location

::: {.column width="32%"}
<center>

![Elastic](figs/example_ff_vert_fdata.png)

</center>
:::

::: {.column width="32%"}
<center>

![Standard](figs/example_ff_fdata.png)

</center>
:::

::: {.column width="32%"}
<center>

![Phase](figs/example_ff_vert_warp.png)

</center>
:::

- The elastic approach appears to align weather patterns, maintaining cyclical behavior in the temperature throughout the year. 
- In contrast, the cross-sectional approach averages these over years while ignoring phase variability. 
- No phase change detected

## Global Results
![](figs/map_ff_both_filter.png)
![](figs/map_ff_both_filter_change.png)

- Left: Elastic, Right: Cross-Sectional

## Summary
- FDA is a very important problem area for statistics
- Can perform statistics using functions, but have to be aware of different set of issues/nuances
- Functional data often comes with phase variability that cannot be handled using standard L2 framework
- Elastic FDA provides more flexibility than classical FDA
    + Amongst the best alignment methods
    + Also provides joint solutions for inferences along with alignments
- Theory and Methods work for functions, curves, surfaces, and images

## Papers

J. D. Tucker and D. Yarger, “Elastic Functional Changepoint Detection of Climate Impacts from Localized Sources”, Envirometrics, 10.1002/env.2826, 2023.

##  {background="#43464B" .center}

<center>

<font size="48">Questions?</font>

jdtuck\@sandia.gov

http://research.tetonedge.net

</center>
